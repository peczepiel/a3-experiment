<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Change Detection Task</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600&display=swap');

        body {
            box-sizing: border-box;
            font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            min-height: 100%;
        }

        html, body { height: 100%; }

        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 32px 24px;
            height: 100%;
            overflow-y: auto;
        }

        .page {
            display: none;
        }
        .page.active {
            display: block;
        }

        .header {
            margin-bottom: 24px;
        }
        .title {
            font-size: 22px; font-weight: 600; color: #1a1a2e; margin: 0 0 8px 0; letter-spacing: -0.3px;
        }
        .subtitle {
            font-size: 14px; color: #5a5a6e; margin: 0; line-height: 1.5;
        }

        .controls { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 18px; font-size: 13px; font-weight: 600; font-family: inherit; border: none; border-radius: 6px; cursor: pointer; transition: all 0.15s ease; }
        .btn, #Color rect { touch-action: manipulation; }
        .btn-primary { background-color: #3d5a80; color: white; }
        .btn-primary:hover { background-color: #2c4a6e; }
        .btn-secondary { background-color: #e8ecf0; color: #3d5a80; }
        .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary.highlighted { background-color: #3d5a80; color: white; }

        .status-badge { display: inline-flex; align-items: center; padding: 6px 14px; background-color: #e8f4f8; border-radius: 20px; font-size: 13px; font-weight: 600; color: #3d5a80; margin-left: auto; }
        .status-dot { width: 8px; height: 8px; background-color: #3d5a80; border-radius: 50%; margin-right: 8px; }

        .stimulus-container { background-color: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); border: 1px solid #e8ecf0; display: flex; justify-content: center; position: relative; }
        #Color { display: block; border-radius: 4px; }
        #Color rect { cursor: pointer; }
        #trialStartBtn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2; width: 320px; height: 320px; border-radius: 4px; display: inline-flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px; text-align: center; font-size: 24px; line-height: 1.2; }
        #trialStartBtn .subtext { font-size: 16px; font-weight: 400; }

        .chart-container { background: white; padding: 20px; margin-top: 20px; border-radius: 8px; border: 1px solid #e8ecf0; }
        .axis-label { font-size: 10px; }
        .d3-tooltip {
            position: absolute;
            text-align: center;
            padding: 8px 12px;
            font: 12px sans-serif;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
        }
        rect {
            transition: fill-opacity 0.2s;
        }
    
        #devToast {
            position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff; 
            padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
    <div class="container">
        
        <div id="homePage" class="page active">
            <div class="header">
                <h1 class="title">Color Change Detection Task</h1>
                <p class="subtitle">Click on the square as soon as you notice its color has changed.<br><br>
                After each reaction, click inside the main box to continue. After 3 color pairings, click the next condition button.</p>
            </div>
            <button id="startBtn" class="btn btn-primary w-full py-4 text-lg">Start Experiment</button>
        </div>

        <div id="testPage" class="page">
            <div class="header">
                <h1 class="title">Test in Progress</h1>
                <p class="subtitle"> Please click the square as soon as you notice its color has changed. Then continue from inside the main box. </p>
            </div>
            <div class="controls">
                <button id="nextBtn" class="btn btn-secondary">Next Condition</button> 
                <button id="doneBtn" class="btn btn-secondary" disabled>Done</button> 
                <span id="contrastLevel" class="status-badge"> <span class="status-dot"></span> <span>Control Test</span> </span>
            </div>
            <div class="stimulus-container">
                <button id="trialStartBtn" class="btn btn-primary">Start Reaction Time Test</button>
                <svg id="Color" width="320" height="320"></svg>
            </div>
            <div style="margin-top: 20px; padding: 16px; background-color: #f0f4f8; border-radius: 6px; border: 1px solid #dce2e8;">
                <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; color: #8a8a9a; font-weight: 600; margin-bottom: 8px;">
                    Last Reaction Time
                </div>
                <div id="reactionTimeDisplay" style="font-size: 24px; font-weight: 600; color: #3d5a80;">—</div>
            </div>
        </div>

        <div id="resultsPage" class="page">
            <div class="header">
                <h1 class="title">Your Results</h1>
                <p class="subtitle">Comparison of your reaction times across different conditions.</p>
            </div>
            <div class="chart-container">
                <h3 class="font-bold mb-2">Contrast vs. Control</h3>
                <div id="chart1"></div>
            </div>
            <div class="chart-container">
                <h1 class="font-bold mb-2">Your Average vs. Global Average</h1>
                <div id="chart2"></div>
            </div>
            <button onclick="location.reload()" class="btn btn-secondary mt-4">Restart</button>
        </div>

    </div>
    <div id="devToast">Dev Mode: Skipped to Results</div>

    <script type="module">
        import { lab } from "https://cdn.jsdelivr.net/npm/d3-color@3/+esm";
        import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
        import axios from "https://cdn.jsdelivr.net/npm/axios@1.6.8/+esm";

        const width = 320;
        const height = 320;

        const controlContrast = [ //neon red to neon green for extreme contrast
            [lab(53, 80, 67), lab(88, -86, 83)], 
            [lab(53, 80, 67), lab(88, -86, 83)], 
            [lab(53, 80, 67), lab(88, -86, 83)]
        ];
        const lowContrast = [[lab(60, 20, 20), lab(50, 15, 15)], [lab(50, -30, 40), lab(40, -35, 35)], [lab(65, 10, -20), lab(75, 15, -15)]];
        const medContrast = [[lab(55, 40, 20), lab(75, 55, 30)], [lab(45, -35, 50), lab(65, -20, 65)], [lab(65, 15, -30), lab(85, 30, -20)]];
        const medHighContrast = [[lab(40, 60, 30), lab(70, 40, 50)], [lab(35, -40, 45), lab(65, -20, 25)], [lab(60, -20, -40), lab(90, 0, -20)]];
        const highContrast = [[lab(85, -40, 15), lab(45, 0, 55)], [lab(80, 20, -30), lab(40, -20, 10)], [lab(90, -10, -10), lab(50, 30, 30)]];

        var svg = d3.select("#Color");

        const contrastLevels = [
            { name: "Control (Baseline)", data: controlContrast },
            { name: "High Contrast", data: highContrast },
            { name: "Med-High Contrast", data: medHighContrast },
            { name: "Medium Contrast", data: medContrast },
            { name: "Low Contrast", data: lowContrast }
        ];

        let currentContrastIndex = 0;
        let currentColorPair = 0;
        let reactedCurrent = false;
        let completedContrasts = new Set();
        const trialStartBtn = document.getElementById('trialStartBtn');
        
        let currentLevelTimes = [];
        let finalResults = [];
        
        //create local PID if it doesn't exist, otherwise use existing one to get previous results
        const PID_KEY = "participantId";
        let participantId = localStorage.getItem(PID_KEY);
        if (!participantId) { participantId = crypto.randomUUID(); localStorage.setItem(PID_KEY, participantId); }

        const api = axios.create({ baseURL: "" });
        const postCondition = (condition, times, avg) => api.post("/api/condition", { participantId, condition, times, avg });
        const getOthers = async () => (await api.get("/api/others-averages", { params: { exclude: participantId } })).data;

        //all of these are for navigating between pages
        document.getElementById('startBtn').addEventListener('click', () => {
            document.getElementById('homePage').classList.remove('active');
            document.getElementById('testPage').classList.add('active');
            resetRects();
            updateContrastDisplay();
        });

        async function showResults() {
            document.getElementById('testPage').classList.remove('active');
            document.getElementById('resultsPage').classList.add('active');
            await renderCharts();
        }

        //experiment logic
        function addColorRect(x, y, size) {
            const colorPair = contrastLevels[currentContrastIndex].data[currentColorPair];
            
            const rect = svg.append("rect")
                .attr("x", x).attr("y", y).attr("width", size).attr("height", size)
                .attr("fill", `lab(${colorPair[0].l} ${colorPair[0].a} ${colorPair[0].b})`);

            const switchTime = Math.random() * 5000 + 2000; //2-7 seconds
            let colorChangeTime = null;
            let hasClicked = false;

            const startTime = performance.now();

            //rAF loop for more consistent timing than setTimeout
            function waitForColorChange(now) {
                if (now - startTime >= switchTime) {
                    rect.attr("fill", `lab(${colorPair[1].l} ${colorPair[1].a} ${colorPair[1].b})`);
                    colorChangeTime = performance.now();
                    return;
                }
                requestAnimationFrame(waitForColorChange);
            }
            requestAnimationFrame(waitForColorChange);

            rect.on("pointerdown", function () {
                if (colorChangeTime && !hasClicked) {
                    hasClicked = true;
                    const reactionTime = performance.now() - colorChangeTime;
                    const displayedReactionTime = Math.round(reactionTime);
                    
                    //save reaction time for this level
                    currentLevelTimes.push(reactionTime);

                    document.getElementById('reactionTimeDisplay').textContent = `${displayedReactionTime} ms`;
                    reactedCurrent = true;
                    svg.selectAll("rect").remove();
                    if (currentColorPair < 2) {
                        setTrialButtonText(`${displayedReactionTime} ms`, "Click to keep going", false);
                    } else {
                        setTrialButtonText(`${displayedReactionTime} ms`, "Click Next Condition", true);
                    }
                    updateButtonStates();
                }
            });
        }

        function setTrialButtonText(primaryText, secondaryText = "", disabled = false) {
            trialStartBtn.innerHTML = secondaryText
                ? `${primaryText}<span class="subtext">${secondaryText}</span>`
                : primaryText;
            trialStartBtn.disabled = disabled;
            trialStartBtn.style.display = 'inline-flex';
        }

        function updateContrastDisplay() {
            const badge = document.getElementById('contrastLevel');
            badge.querySelector('span:last-child').textContent = contrastLevels[currentContrastIndex].name;
        }

        function updateButtonStates() {
            const nextBtn = document.getElementById('nextBtn');
            const doneBtn = document.getElementById('doneBtn');

            if (completedContrasts.size === contrastLevels.length) {
                nextBtn.disabled = true;
                doneBtn.disabled = false; doneBtn.classList.add('highlighted');
                return;
            }

            if (!reactedCurrent) {
                nextBtn.disabled = true; doneBtn.disabled = true;
                nextBtn.classList.remove('highlighted'); doneBtn.classList.remove('highlighted');
                return;
            }

            if (currentColorPair === 2) {
                nextBtn.disabled = false; nextBtn.classList.add('highlighted');
            } else {
                nextBtn.disabled = true; nextBtn.classList.remove('highlighted');
            }
        }

        function resetRects() {
            svg.selectAll("rect").remove();
            reactedCurrent = false;
            setTrialButtonText("Start Reaction Time Test");
            updateButtonStates();
        }

        trialStartBtn.addEventListener('click', () => {
            if (reactedCurrent && currentColorPair < 2) {
                currentColorPair += 1;
                reactedCurrent = false;
                updateButtonStates();
            }
            trialStartBtn.style.display = 'none';
            const size = 320;
            const x = (width - size) / 2;
            const y = (height - size) / 2;
            addColorRect(x, y, size);
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentColorPair == 2) {
                //calc avg for this level
                const avgRaw = currentLevelTimes.reduce((a, b) => a + b, 0) / currentLevelTimes.length;
                finalResults.push({
                    condition: contrastLevels[currentContrastIndex].name,
                    avgTimeRaw: avgRaw,
                    avgTime: Math.round(avgRaw)
                });
                postCondition(contrastLevels[currentContrastIndex].name, currentLevelTimes, avgRaw)
                    .catch(error => console.error("Failed to save condition", error));
                
                currentLevelTimes = [];

                completedContrasts.add(currentContrastIndex);

                if (completedContrasts.size === contrastLevels.length) {
                    document.getElementById('nextBtn').disabled = true;
                    const doneBtn = document.getElementById('doneBtn');
                    doneBtn.disabled = false;
                    doneBtn.classList.add('highlighted');
                    document.getElementById('contrastLevel').querySelector('span:last-child').textContent = "Complete";
                    return;
                }

                currentColorPair = 0;
                currentContrastIndex = (currentContrastIndex + 1) % contrastLevels.length;
                updateContrastDisplay();
                resetRects();
            }
        });

        document.getElementById('doneBtn').addEventListener('click', () => {
            showResults();
        });

        //chart logic
        async function renderCharts() {
            const otherUsersAvg = await getOthers();

            //dimensions
            const margin = { top: 30, right: 30, bottom: 60, left: 60 }; 
            const width = 600 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            d3.select(".d3-tooltip").remove();
            const tooltip = d3.select("body").append("div").attr("class", "d3-tooltip");

            const mouseover = function(event, d) {
                tooltip.style("opacity", 1);
                d3.select(this).style("fill-opacity", 0.7);
            };

            const mouseleave = function(event, d) {
                tooltip.style("opacity", 0);
                d3.select(this).style("fill-opacity", 1);
            };

            //chart 1, just you
            d3.select("#chart1").html("");
            const svg1 = d3.select("#chart1")
                .append("svg")
                .attr("viewBox", `0 0 600 300`)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x1 = d3.scaleBand()
                .range([0, width])
                .domain(finalResults.map(d => d.condition))
                .padding(0.3);

            const y1 = d3.scaleLinear()
                .domain([0, d3.max(finalResults, d => d.avgTime) + 100])
                .range([height, 0]);

            //lines
            svg1.append("g")
                .attr("class", "grid")
                .attr("opacity", 0.1)
                .call(d3.axisLeft(y1).tickSize(-width).tickFormat(""));

            //axises
            svg1.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x1))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-20)")
                .style("text-anchor", "end")
                .style("font-size", "11px");

            svg1.append("g").call(d3.axisLeft(y1));

            //bars
            svg1.selectAll("mybar")
                .data(finalResults)
                .join("rect")
                .attr("x", d => x1(d.condition))
                .attr("width", x1.bandwidth())
                .attr("fill", "#3d5a80")
                .attr("rx", 4)
                .attr("y", height)
                .attr("height", 0)
                .on("mouseover", mouseover)
                .on("mousemove", (event, d) => {
                    tooltip
                        .html(`<strong>${d.condition}</strong><br>Time: ${d.avgTime.toFixed(1)} ms`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseleave", mouseleave)
                .transition().duration(800)
                .attr("y", d => y1(d.avgTime))
                .attr("height", d => height - y1(d.avgTime));

            //chart 2, you vs others
            d3.select("#chart2").html("");
            const svg2 = d3.select("#chart2")
                .append("svg")
                .attr("viewBox", `0 0 600 300`)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const subgroups = ["You", "Others"];
            const groups = finalResults.map(resultEntry => resultEntry.condition);

            const combinedData = finalResults.map((resultEntry) => {
                const matchingOtherAverage = otherUsersAvg.find(otherEntry => otherEntry.condition === resultEntry.condition);
                return {
                    group: resultEntry.condition,
                    You: resultEntry.avgTimeRaw,
                    Others: matchingOtherAverage?.avgTime ?? 0
                };
            });

            const x2 = d3.scaleBand().domain(groups).range([0, width]).padding(0.2);
            const xSub = d3.scaleBand().domain(subgroups).range([0, x2.bandwidth()]).padding(0.05);
            const y2 = d3.scaleLinear().domain([0, 1000]).range([height, 0]);
            const color = d3.scaleOrdinal().domain(subgroups).range(["#3d5a80", "#98c1d9"]);

            //lines
            svg2.append("g")
                .attr("class", "grid")
                .attr("opacity", 0.1)
                .call(d3.axisLeft(y2).tickSize(-width).tickFormat(""));

            //axises
            svg2.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x2))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-20)")
                .style("text-anchor", "end")
                .style("font-size", "11px");

            svg2.append("g").call(d3.axisLeft(y2));

            //legend
            const legend = svg2.append("g").attr("transform", `translate(${width - 100}, -20)`);
            subgroups.forEach((groupName, i) => {
                const legendRow = legend.append("g").attr("transform", `translate(0, ${i * 20})`);
                legendRow.append("rect").attr("width", 12).attr("height", 12).style("fill", color(groupName)).attr("rx", 2);
                legendRow.append("text").attr("x", 18).attr("y", 10).text(groupName).style("font-size", "12px").style("font-family", "sans-serif").attr("alignment-baseline", "middle");
            });

            //bars
            svg2.append("g")
                .selectAll("g")
                .data(combinedData)
                .join("g")
                .attr("transform", d => `translate(${x2(d.group)}, 0)`)
                .selectAll("rect")
                .data(d => subgroups.map(key => ({ key: key, value: d[key], groupName: d.group })))
                .join("rect")
                .attr("x", d => xSub(d.key))
                .attr("width", xSub.bandwidth())
                .attr("fill", d => color(d.key))
                .attr("rx", 3)
                .attr("y", height)
                .attr("height", 0)
                .on("mouseover", mouseover)
                .on("mousemove", (event, d) => {
                    tooltip
                        .html(`<strong>${d.groupName}</strong><br>${d.key}: ${d.value ? d.value.toFixed(1) : 0}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseleave", mouseleave)
                .transition().duration(800)
                .attr("y", d => y2(d.value))
                .attr("height", d => height - y2(d.value));
        }

        //dev shortcut to graph for editing
        window.triggerDevSkip = async () => {
            console.log("⚡ Dev Mode: Skipped to Results");
            
            //fill results with fake data to not break graphs
            finalResults = contrastLevels.map((lvl, i) => ({
                condition: lvl.name,
                avgTimeRaw: 350 + (i * 120),
                avgTime: 350 + (i * 120)
            }));

            //sync backend with fake data so no crash
            api.get = async () => ({
                data: contrastLevels.map((lvl, i) => ({
                    condition: lvl.name,
                    avgTime: 400 + (i * 100)
                }))
            });

            document.getElementById('homePage').classList.remove('active');
            document.getElementById('testPage').classList.remove('active');
            document.getElementById('resultsPage').classList.add('active');

            //show dev message
            const toast = document.getElementById('devToast');
            toast.style.opacity = 1;
            setTimeout(() => toast.style.opacity = 0, 2000);

            await renderCharts();
        };

        //listen for dev command
        //cntrl + alt + U
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.altKey && e.code === 'KeyU') {
                e.preventDefault();
                window.triggerDevSkip();
            }
        });

    </script>
</body>
</html>