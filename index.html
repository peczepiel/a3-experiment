<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Change Detection Task</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600&display=swap');

        body {
            box-sizing: border-box;
            font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            min-height: 100%;
        }

        html,
        body {
            height: 100%;
        }

        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 32px 24px;
            height: 100%;
            overflow-y: auto;
        }

        .header {
            margin-bottom: 24px;
        }

        .title {
            font-size: 22px;
            font-weight: 600;
            color: #1a1a2e;
            margin: 0 0 8px 0;
            letter-spacing: -0.3px;
        }

        .subtitle {
            font-size: 14px;
            color: #5a5a6e;
            margin: 0;
            line-height: 1.5;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 18px;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background-color: #3d5a80;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2c4a6e;
        }

        .btn-secondary {
            background-color: #e8ecf0;
            color: #3d5a80;
        }

        .btn-secondary:hover {
            background-color: #dce2e8;
        }

        .btn-primary:disabled {
            background-color: #d0d9e3;
            color: #a0a5b0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary:disabled {
            background-color: #dce2e8;
            color: #8a8a9a;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary.highlighted {
            background-color: #3d5a80;
            color: white;
            font-weight: 700;
        }

        .btn-secondary.highlighted:hover {
            background-color: #2c4a6e;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            background-color: #e8f4f8;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: #3d5a80;
            margin-left: auto;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background-color: #3d5a80;
            border-radius: 50%;
            margin-right: 8px;
        }

        .stimulus-container {
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8ecf0;
            display: flex;
            justify-content: center;
        }

        .stimulus-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #8a8a9a;
            margin-bottom: 12px;
            font-weight: 600;
        }

        #Color {
            display: block;
            border-radius: 4px;
        }

        #Color rect {
            cursor: pointer;
            border-radius: 4px;
        }
    </style>
    <style>
        @view-transition {
            navigation: auto;
        }
    </style>
    <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Color Change Detection Task</h1>
            <p class="subtitle">Click on the square as soon as you notice its color has changed. Once clicked, click the
                next color pair button to proceed.
                Once you've gone through 3 colors pairings at each contrast level, click the next condition button to
                move to the next contrast level.</p>
        </div>
        <div class="controls"><button id="resetBtn" class="btn btn-primary">Next Color Pair</button> <button
            id="nextBtn" class="btn btn-secondary">Next Condition</button> <button id="doneBtn" class="btn btn-secondary" disabled>Done</button> <span id="contrastLevel"
            class="status-badge"> <span class="status-dot"></span> <span>High Contrast</span> </span>
        </div>
        <div class="stimulus-container">
            <svg id="Color" width="320" height="320"></svg>
        </div>
        <div
            style="margin-top: 20px; padding: 16px; background-color: #f0f4f8; border-radius: 6px; border: 1px solid #dce2e8;">
            <div
                style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; color: #8a8a9a; font-weight: 600; margin-bottom: 8px;">
                Last Reaction Time
            </div>
            <div id="reactionTimeDisplay" style="font-size: 24px; font-weight: 600; color: #3d5a80;">
                —
            </div>
        </div>
    </div>
    <script type="module">

        import { lab } from "https://cdn.jsdelivr.net/npm/d3-color@3/+esm";
        import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

        const width = 320;
        const height = 320;

        const lowContrast = [
            [lab(60, 20, 20), lab(50, 15, 15)],  
            [lab(50, -30, 40), lab(40, -35, 35)],
            [lab(65, 10, -20), lab(75, 15, -15)]
        ];

        const medContrast = [
            [lab(55, 40, 20), lab(75, 55, 30)],
            [lab(45, -35, 50), lab(65, -20, 65)],
            [lab(65, 15, -30), lab(85, 30, -20)]
        ];


        const medHighContrast = [
            [lab(40, 60, 30), lab(70, 40, 50)],
            [lab(35, -40, 45), lab(65, -20, 25)],
            [lab(60, -20, -40), lab(90, 0, -20)]
        ];

        const highContrast = [
            [lab(85, -40, 15), lab(45, 0, 55)],
            [lab(80, 20, -30), lab(40, -20, 10)],
            [lab(90, -10, -10), lab(50, 30, 30)]
        ];

        var svg = d3.select("#Color");

        // Array of contrast levels in orders
        const contrastLevels = [
            { name: "High Contrast", data: highContrast },
            { name: "Med-High Contrast", data: medHighContrast },
            { name: "Medium Contrast", data: medContrast },
            { name: "Low Contrast", data: lowContrast }
        ];
        let currentContrastIndex = 0;
        let currentColorPair = 0;
        let reactedCurrent = false;
        const completedContrasts = new Set();

        // Function to add a color-switching rect
        function addColorRect(x, y, size) {
            // Randomly select a pairing from current contrast level
            const colorPair = contrastLevels[currentContrastIndex].data[currentColorPair];

            // Create the rect with first color
            const rect = svg.append("rect")
                .attr("x", x)
                .attr("y", y)
                .attr("width", size)
                .attr("height", size)
                .attr("fill", `lab(${colorPair[0].l} ${colorPair[0].a} ${colorPair[0].b})`);

            // Set random time (between 3s and 10s) to switch colors
            const switchTime = Math.random() * 7000 + 3000;
            let colorChangeTime = null;
            let hasClicked = false;

            setTimeout(() => {
                rect.attr("fill", `lab(${colorPair[1].l} ${colorPair[1].a} ${colorPair[1].b})`);
                colorChangeTime = Date.now();

                console.log(`Square switched colors after ${switchTime.toFixed(2)} ms`);
                console.log(`Color pair: ${colorPair[0].toString()} -> ${colorPair[1].toString()}`);
            }, switchTime);

            // Add click handler to track reaction time
            rect.on("click", function () {
                if (colorChangeTime && !hasClicked) {
                    hasClicked = true;
                    const reactionTime = Date.now() - colorChangeTime;
                    console.log(`Reaction time: ${reactionTime} ms`);

                    // Update the display
                    document.getElementById('reactionTimeDisplay').textContent = `${reactionTime} ms`;

                    // Mark that the user reacted to the current switch and update buttons
                    reactedCurrent = true;
                    updateButtonStates();
                }
            });
        }

        // Function to update the contrast level display
        function updateContrastDisplay() {
            const badge = document.getElementById('contrastLevel');
            badge.querySelector('span:last-child').textContent = contrastLevels[currentContrastIndex].name;
        }

        // Function to update button states
        function updateButtonStates() {
            const resetBtn = document.getElementById('resetBtn');
            const nextBtn = document.getElementById('nextBtn');
            const doneBtn = document.getElementById('doneBtn');

            // If all contrasts completed, enable Done and disable others
            if (completedContrasts.size === contrastLevels.length) {
                resetBtn.disabled = true;
                nextBtn.disabled = true;
                doneBtn.disabled = false;
                doneBtn.classList.add('highlighted');
                nextBtn.classList.remove('highlighted');
                return;
            }

            // Disable both until the participant has reacted to the current change
            if (!reactedCurrent) {
                resetBtn.disabled = true;
                nextBtn.disabled = true;
                doneBtn.disabled = true;
                nextBtn.classList.remove('highlighted');
                doneBtn.classList.remove('highlighted');
                return;
            }

            // After reaction: if last color pair, enable next condition; otherwise enable next color pair
            doneBtn.disabled = true;
            doneBtn.classList.remove('highlighted');

            if (currentColorPair === 2) {
                resetBtn.disabled = true;
                nextBtn.disabled = false;
                nextBtn.classList.add('highlighted');
            } else {
                resetBtn.disabled = false;
                nextBtn.disabled = true;
                nextBtn.classList.remove('highlighted');
            }
        }

        // Function to reset and regenerate the single rect
        function resetRects() {
            svg.selectAll("rect").remove();
            // Reset reacted state for the new trial
            reactedCurrent = false;
            const size = 300;
            const x = (width - size) / 2;
            const y = (height - size) / 2;
            addColorRect(x, y, size);
            updateButtonStates();
        }

        // Reset button handler
        document.getElementById('resetBtn').addEventListener('click', () => {
            currentColorPair = (currentColorPair + 1) % 3;
            resetRects();
        });

        // Next contrast level button handler
        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentColorPair == 2) {
                // Mark this contrast as completed
                completedContrasts.add(currentContrastIndex);

                // If all contrasts completed, enable Done and show congrats
                if (completedContrasts.size === contrastLevels.length) {
                    document.getElementById('resetBtn').disabled = true;
                    document.getElementById('nextBtn').disabled = true;
                    const doneBtn = document.getElementById('doneBtn');
                    doneBtn.disabled = false;
                    doneBtn.classList.add('highlighted');
                    document.getElementById('contrastLevel').querySelector('span:last-child').textContent = "All Conditions Completed";
                    alert('Congratulations — you have completed all contrast levels!');
                    return;
                }

                // Move to next contrast
                currentColorPair = 0;
                currentContrastIndex = (currentContrastIndex + 1) % contrastLevels.length;
                updateContrastDisplay();
                resetRects();
            }
        });

        // Done button handler
        document.getElementById('doneBtn').addEventListener('click', () => {
            alert('Well done! You have finished the experiment.');
            document.getElementById('doneBtn').disabled = true;
        });

        // Initial setup
        resetRects();

    </script>

</html>